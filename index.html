/*
Anonymous Live Chat - Full React App with Firebase Config
Updated with your Firebase project credentials.
*/

import React, { useEffect, useState, useRef } from "react";
import { initializeApp } from "firebase/app";
import {
  getFirestore,
  collection,
  query,
  orderBy,
  onSnapshot,
  addDoc,
  serverTimestamp,
  setDoc,
  doc,
  getDoc,
  deleteDoc
} from "firebase/firestore";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "firebase/storage";
import { v4 as uuidv4 } from "uuid";

// âœ… Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBaHvhQDLsIVISjIe_IDl6i-iERYJLTgaI",
  authDomain: "anon-chat-39ea7.firebaseapp.com",
  projectId: "anon-chat-39ea7",
  storageBucket: "anon-chat-39ea7.firebasestorage.app",
  messagingSenderId: "809487057402",
  appId: "1:809487057402:web:03bc9edc356bf3a69c6443"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Helpers
const randomName = () => {
  const adjectives = ["Quiet","Swift","Blue","Pixel","Shadow","Lucky","Silent","Brave","Tiny","Happy"];
  const animals = ["Fox","Otter","Raven","Panda","Tiger","Wolf","Koala","Sparrow","Seal","Bee"];
  return `${adjectives[Math.floor(Math.random()*adjectives.length)]}${animals[Math.floor(Math.random()*animals.length)]}${Math.floor(Math.random()*900)+100}`;
};

export default function AnonymousChatApp() {
  const [stage, setStage] = useState("lobby");
  const [roomCode, setRoomCode] = useState("");
  const [joinCode, setJoinCode] = useState("");
  const [name, setName] = useState(() => randomName());
  const [messages, setMessages] = useState([]);
  const [text, setText] = useState("");
  const [imageFile, setImageFile] = useState(null);
  const messagesRef = useRef(null);

  // Create room
  const createRoom = async () => {
    const code = Math.random().toString(36).slice(2,8).toUpperCase();
    const rDoc = doc(db, "rooms", code);
    await setDoc(rDoc, { code, createdAt: serverTimestamp() });
    setRoomCode(code);
    setStage("room");
    subscribeToRoom(code);
  };

  // Join room
  const joinRoom = async () => {
    const code = joinCode.trim().toUpperCase();
    if (!code) return alert("Enter room code");
    const rDoc = doc(db, "rooms", code);
    const snap = await getDoc(rDoc);
    if (!snap.exists()) return alert("Room not found");
    setRoomCode(code);
    setStage("room");
    subscribeToRoom(code);
  };

  const subscribeToRoom = (code) => {
    const q = query(collection(db, "rooms", code, "messages"), orderBy("createdAt","asc"));
    return onSnapshot(q, snap => {
      const arr = [];
      snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
      setMessages(arr);
      setTimeout(()=> messagesRef.current?.scrollTo({ top: messagesRef.current.scrollHeight, behavior: "smooth" }), 50);
    });
  };

  const sendMessage = async () => {
    if (!roomCode) return;
    let imageURL = null;
    if (imageFile) {
      const id = uuidv4();
      const sRef = storageRef(storage, `rooms/${roomCode}/images/${id}`);
      await uploadBytes(sRef, imageFile);
      imageURL = await getDownloadURL(sRef);
      setImageFile(null);
    }
    const m = { senderName: name, text, imageURL, createdAt: serverTimestamp() };
    await addDoc(collection(db, "rooms", roomCode, "messages"), m);
    setText("");
  };

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col">
      {stage === "lobby" && (
        <div className="m-auto bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
          <h1 className="text-2xl font-bold mb-3">Anonymous Live Chat</h1>
          <p className="text-sm text-gray-600 mb-4">Create or join a chat room. Messages auto-delete after 30 min.</p>
          <input value={name} onChange={e=>setName(e.target.value)} placeholder="Your name" className="border p-2 w-full mb-3 rounded" />
          <button onClick={createRoom} className="w-full bg-green-500 text-white p-2 rounded mb-3">Create Room</button>
          <div className="flex gap-2">
            <input value={joinCode} onChange={e=>setJoinCode(e.target.value)} placeholder="Room code" className="flex-1 border p-2 rounded" />
            <button onClick={joinRoom} className="bg-blue-500 text-white p-2 rounded">Join</button>
          </div>
        </div>
      )}

      {stage === "room" && (
        <>
          <div className="bg-white shadow p-3 flex justify-between items-center">
            <div>
              <div className="text-lg font-bold">Room: {roomCode}</div>
              <div className="text-sm text-gray-500">You: {name}</div>
            </div>
            <button onClick={()=>{setStage("lobby"); setRoomCode(""); setMessages([]);}} className="text-sm border p-2 rounded">Leave</button>
          </div>
          <div ref={messagesRef} className="flex-1 overflow-auto p-3 space-y-3">
            {messages.map(m => (
              <div key={m.id} className="bg-white p-3 rounded-xl shadow w-fit max-w-[80%]">
                <div className="text-xs text-gray-500">{m.senderName}</div>
                <div className="mt-1 whitespace-pre-wrap">{m.text}</div>
                {m.imageURL && <img src={m.imageURL} alt="shared" className="mt-2 rounded max-h-56" />}
              </div>
            ))}
          </div>
          <div className="p-3 bg-white border-t flex gap-2">
            <input type="file" accept="image/*" onChange={e=>setImageFile(e.target.files[0])} className="hidden" id="imgUpload" />
            <label htmlFor="imgUpload" className="border p-2 rounded cursor-pointer">ðŸ“·</label>
            <input value={text} onChange={e=>setText(e.target.value)} placeholder="Message" className="flex-1 border p-2 rounded" />
            <button onClick={sendMessage} className="bg-blue-600 text-white px-4 rounded">Send</button>
          </div>
        </>
      )}
    </div>
  );
}
